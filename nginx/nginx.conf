worker_processes auto;

events {
    worker_connections 2048;
    use epoll;
    multi_accept on;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout 65;
    server_tokens   off;

    # ─── Rate Limit Zones ────────────────────────────────────────────────────
    # Forge + Software: AI calls cost money — 10 req/min per IP
    limit_req_zone $binary_remote_addr zone=forge:10m   rate=10r/m;
    # Audit: spins up real browsers — 3 req/min per IP
    limit_req_zone $binary_remote_addr zone=audit:10m   rate=3r/m;
    # General API: 60 req/min per IP
    limit_req_zone $binary_remote_addr zone=api:10m     rate=60r/m;

    limit_req_status 429;
    limit_conn_status 429;

    # ─── Logging ─────────────────────────────────────────────────────────────
    log_format json escape=json
        '{"ts":"$time_iso8601",'
        '"ip":"$remote_addr",'
        '"method":"$request_method",'
        '"path":"$request_uri",'
        '"status":$status,'
        '"bytes":$body_bytes_sent,'
        '"rt":"$request_time",'
        '"ua":"$http_user_agent"}';

    access_log /var/log/nginx/access.log json;
    error_log  /var/log/nginx/error.log  warn;

    # ─── Upstream ────────────────────────────────────────────────────────────
    upstream app {
        server app:3000;
        keepalive 32;
    }

    # ─── HTTP → HTTPS redirect ───────────────────────────────────────────────
    server {
        listen 80;
        server_name _;

        # Let Certbot answer ACME challenges over HTTP
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        location / {
            return 301 https://$host$request_uri;
        }
    }

    # ─── HTTPS ───────────────────────────────────────────────────────────────
    server {
        listen 443 ssl http2;
        server_name REPLACE_WITH_YOUR_DOMAIN;

        ssl_certificate     /etc/letsencrypt/live/REPLACE_WITH_YOUR_DOMAIN/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/REPLACE_WITH_YOUR_DOMAIN/privkey.pem;

        ssl_protocols       TLSv1.2 TLSv1.3;
        ssl_ciphers         ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;
        ssl_session_cache   shared:SSL:10m;
        ssl_session_timeout 1d;
        ssl_stapling        on;
        ssl_stapling_verify on;

        # ─── Security Headers ───────────────────────────────────────────────
        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains" always;
        add_header X-Frame-Options           DENY                                  always;
        add_header X-Content-Type-Options    nosniff                               always;
        add_header Referrer-Policy           strict-origin-when-cross-origin       always;

        client_max_body_size 1m;

        # ─── Skill Forge (AI expensive) ─────────────────────────────────────
        location /api/forge {
            limit_req zone=forge burst=5 nodelay;
            proxy_pass         http://app;
            proxy_http_version 1.1;
            proxy_set_header   Host            $host;
            proxy_set_header   X-Real-IP       $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_read_timeout 120s;
        }

        # ─── Software Fabricator (AI expensive) ─────────────────────────────
        location /api/software {
            limit_req zone=forge burst=5 nodelay;
            proxy_pass         http://app;
            proxy_http_version 1.1;
            proxy_set_header   Host            $host;
            proxy_set_header   X-Real-IP       $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_read_timeout 180s;
        }

        # ─── Stealth Audit (real browser, very heavy) ────────────────────────
        location /api/audit {
            limit_req zone=audit burst=2 nodelay;
            proxy_pass         http://app;
            proxy_http_version 1.1;
            proxy_set_header   Host            $host;
            proxy_set_header   X-Real-IP       $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_read_timeout 300s;
        }

        # ─── All other API routes ────────────────────────────────────────────
        location /api/ {
            limit_req zone=api burst=20 nodelay;
            proxy_pass         http://app;
            proxy_http_version 1.1;
            proxy_set_header   Host            $host;
            proxy_set_header   X-Real-IP       $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_read_timeout 30s;
        }

        # ─── Next.js frontend + static assets ───────────────────────────────
        location /_next/static/ {
            proxy_pass         http://app;
            proxy_cache_valid  200 1y;
            add_header         Cache-Control "public, immutable";
        }

        location / {
            proxy_pass         http://app;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade         $http_upgrade;
            proxy_set_header   Connection      "upgrade";
            proxy_set_header   Host            $host;
            proxy_set_header   X-Real-IP       $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_read_timeout 30s;
        }
    }
}
