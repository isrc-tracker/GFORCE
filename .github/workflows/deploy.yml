name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: SSH Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:     ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key:      ${{ secrets.SSH_PRIVATE_KEY }}
          port:     ${{ secrets.SERVER_PORT || 22 }}
          script: |
            set -e
            cd /opt/g-force

            echo "── Pulling latest code ──"
            git pull origin main

            echo "── Rebuilding app container ──"
            docker compose build --no-cache app

            echo "── Rolling restart (zero downtime) ──"
            docker compose up -d --no-deps --wait app

            echo "── Pruning old images ──"
            docker image prune -f

            echo "── Deployment complete ──"
            docker compose ps
